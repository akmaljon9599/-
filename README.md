# Модуль "Курьерская служба" для Bitrix24

## Описание

Полнофункциональный модуль для управления курьерской службой с интеграцией с АБС банка и отслеживанием местоположения курьеров в реальном времени.

## Ключевые особенности

### 1. Система ролей и прав доступа
- **Администратор**: Полный доступ ко всем функциям, управление настройками системы
- **Старший курьер**: Управление курьерами, переназначение заявок, печать договоров
- **Курьер**: Изменение статусов заявок, загрузка фото, отслеживание местоположения
- **Оператор**: Добавление и редактирование заявок, работа с клиентской базой

### 2. Интеграция с внешними системами
- API-интеграция с АБС банком через безопасный шлюз
- Интеграция с Яндекс.Картами для отображения адресов и маршрутов
- Автоматическое обновление местоположения курьеров каждые 60 секунд

### 3. Система управления заявками
- Комплексные фильтры с возможностью очистки и применения
- Выгрузка данных в Excel-формате
- Система статусов с различными workflow для каждого статуса

### 4. Система документооборота
- Электронная подпись клиента с преобразованием в PDF
- Печать договоров оферты
- Хранение и управление сканами документов (паспорта, договоры)

### 5. Безопасность и отслеживание
- Фоновая отправка геолокации курьеров
- Разграничение прав доступа к документам
- Логирование всех действий в системе

### 6. Современный интерфейс
- Адаптивный дизайн для различных устройств
- Минималистичный стиль с акцентом на функциональность
- Интуитивная навигация и быстрый доступ к ключевым функциям

## Структура проекта

```
courier_service/
├── install/                          # Установочные файлы модуля
│   ├── index.php                     # Главный файл установки
│   ├── version.php                   # Версия модуля
│   ├── step.php                      # Страница успешной установки
│   ├── unstep.php                    # Страница удаления
│   └── lang/ru/                      # Локализация
│       ├── include.php               # Языковые константы
│       ├── step.php                  # Тексты установки
│       └── unstep.php                # Тексты удаления
├── lib/                              # Основная логика модуля
│   ├── main/                         # Классы для работы с данными
│   │   ├── request.php               # Таблица заявок
│   │   ├── courier.php               # Таблица курьеров
│   │   ├── branch.php                # Таблица филиалов
│   │   ├── department.php            # Таблица подразделений
│   │   ├── document.php              # Таблица документов
│   │   ├── log.php                   # Таблица логов
│   │   └── setting.php               # Таблица настроек
│   ├── api/                          # API для внешних интеграций
│   │   ├── abs_gateway.php           # Шлюз для АБС банка
│   │   └── yandex_maps.php           # Интеграция с Яндекс.Картами
│   ├── utils/                        # Утилиты
│   │   ├── pdf_generator.php         # Генерация PDF документов
│   │   ├── excel_exporter.php        # Экспорт в Excel
│   │   ├── signature_handler.php     # Обработка электронных подписей
│   │   └── location_tracker.php      # Отслеживание местоположения
│   ├── security/                     # Безопасность
│   │   ├── permission_manager.php    # Управление правами доступа
│   │   └── audit_logger.php          # Система аудита
│   └── eventhandlers/                # Обработчики событий
│       └── main.php                  # Обработчики событий Bitrix
├── admin/                            # Административные страницы
│   ├── courier_service_requests.php  # Управление заявками
│   └── lang/ru/                      # Локализация админки
│       └── courier_service_requests.php
├── components/                       # Компоненты
│   └── courier_service/
│       └── courier.map/              # Компонент карты курьеров
│           ├── class.php             # Класс компонента
│           ├── template.php          # Шаблон компонента
│           ├── lang/ru/              # Локализация
│           │   └── template.php
│           └── ajax/
│               └── get_couriers.php  # AJAX для получения курьеров
├── ajax/                             # AJAX контроллеры
│   └── request_actions.php           # Действия с заявками
├── templates/                        # Шаблоны
│   └── courier_service/
│       └── index.php                 # Главная страница дашборда
├── bitrix/                           # Статические ресурсы
│   ├── js/courier_service/
│   │   └── main.js                   # Основной JavaScript
│   └── css/courier_service/
│       └── main.css                  # Основные стили
└── include.php                       # Автозагрузчик классов
```

## Установка

1. Скопируйте папку `courier_service` в директорию `/bitrix/modules/`
2. Перейдите в админку Bitrix24: Настройки → Управление структурой → Модули
3. Найдите модуль "Курьерская служба" и нажмите "Установить"
4. После установки перейдите в настройки модуля для конфигурации

## Настройка

### 1. Настройка API ключей
- Получите API ключ Яндекс.Карт
- Настройте параметры подключения к АБС банка
- Укажите настройки в админке модуля

### 2. Создание пользователей и групп
Модуль автоматически создает следующие группы пользователей:
- `COURIER_ADMIN` - Администраторы курьерской службы
- `COURIER_SENIOR` - Старшие курьеры
- `COURIER_DELIVERY` - Курьеры
- `COURIER_OPERATOR` - Операторы курьерской службы

### 3. Настройка филиалов и подразделений
Создайте филиалы и подразделения через административную панель модуля.

## Использование

### Управление заявками
1. Перейдите в раздел "Заявки"
2. Используйте фильтры для поиска нужных заявок
3. Создавайте новые заявки или редактируйте существующие
4. Назначайте курьеров и отслеживайте статусы

### Отслеживание курьеров
1. Перейдите в раздел "Карта"
2. Просматривайте местоположение курьеров в реальном времени
3. Используйте таблицу для детальной информации

### Работа с документами
1. Загружайте скан-копии документов
2. Используйте электронную подпись клиентов
3. Генерируйте договоры в PDF формате

### Экспорт данных
1. Применяйте необходимые фильтры
2. Нажмите "Экспорт в Excel"
3. Получите файл с данными

## API

### AJAX методы

#### Обновление статуса заявки
```javascript
POST /bitrix/ajax/request_actions.php
{
    "action": "update_status",
    "request_id": 123,
    "status": "delivered",
    "courier_phone": "+7900123456"
}
```

#### Назначение курьера
```javascript
POST /bitrix/ajax/request_actions.php
{
    "action": "assign_courier",
    "request_id": 123,
    "courier_id": 456
}
```

#### Сохранение подписи
```javascript
POST /bitrix/ajax/request_actions.php
{
    "action": "save_signature",
    "request_id": 123,
    "signature_data": "base64_string",
    "signature_format": "base64"
}
```

### Интеграция с АБС банка

Модуль предоставляет класс `AbsGateway` для интеграции:

```php
use CourierService\Api\AbsGateway;

$gateway = new AbsGateway();

// Получение данных клиента
$clientData = $gateway->getClientData($clientId);

// Создание заявки в АБС
$result = $gateway->createRequest($requestData);

// Обновление статуса
$gateway->updateRequestStatus($requestId, $status);
```

## Безопасность

### Система прав доступа
- Каждая операция проверяется на уровне класса `PermissionManager`
- Роли пользователей определяют доступные действия
- Фильтрация данных по принадлежности к филиалам/подразделениям

### Аудит действий
- Все действия пользователей логируются в таблицу `courier_logs`
- Поддержка поиска по логам
- Автоматическая очистка старых записей

### Защита данных
- Использование CSRF токенов
- Валидация всех входных данных
- Безопасное хранение файлов

## Производительность

### Оптимизация запросов
- Использование индексов в базе данных
- Кеширование часто используемых данных
- Пагинация в списках

### Отслеживание местоположения
- Обновление координат каждые 60 секунд
- Фильтрация по расстоянию (настраиваемый параметр)
- Автоматическое определение статуса "онлайн/оффлайн"

## Расширение функциональности

### Добавление новых статусов заявок
1. Обновите метод `getStatusList()` в классе `RequestTable`
2. Добавьте соответствующие стили в CSS
3. Обновите логику обработки в AJAX контроллерах

### Интеграция с новыми внешними системами
1. Создайте новый класс в папке `lib/api/`
2. Реализуйте необходимые методы API
3. Добавьте настройки в админку модуля

### Кастомизация интерфейса
1. Измените шаблоны в папке `templates/`
2. Обновите стили в `bitrix/css/courier_service/main.css`
3. Добавьте JavaScript логику в `bitrix/js/courier_service/main.js`

## Техническая поддержка

При возникновении проблем:
1. Проверьте логи системы в разделе "Логи" модуля
2. Убедитесь в корректности настроек API
3. Проверьте права доступа пользователей
4. Обратитесь к разработчику с описанием проблемы

## Лицензия

Модуль разработан для использования в корпоративной среде и требует соответствующую лицензию.

---

**Версия:** 1.0.0  
**Дата:** 2024-01-15  
**Совместимость:** Bitrix24, PHP 7.4+, MySQL 5.7+